{% extends "base.html" %}
{% load static %}

{% block title %}{{ deck.name }} - Power Calculator - Eternal Forge{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold">{{ deck.name }}</h1>
        <p class="text-gray-400">Power Calculator</p>
    </div>
    <a href="{% url 'decks:deck_detail' deck.pk %}"
       class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm">Back to Deck</a>
</div>

<!-- Power Base Summary -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-gray-800 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-amber-500">{{ total_power }}</div>
        <div class="text-gray-400 text-sm">Total Power Cards</div>
        <div class="text-gray-500 text-xs mt-1">of {{ total_cards }} cards</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-green-500">{{ undepleted_count }}</div>
        <div class="text-gray-400 text-sm">Undepleted</div>
        <div class="text-gray-500 text-xs mt-1">Sigils, Waystones</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-yellow-500">{{ conditional_count }}</div>
        <div class="text-gray-400 text-sm">Conditional</div>
        <div class="text-gray-500 text-xs mt-1">Seats, Banners</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-red-500">{{ depleted_count }}</div>
        <div class="text-gray-400 text-sm">Always Depleted</div>
        <div class="text-gray-500 text-xs mt-1">Crests, Monuments</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4 text-center">
        <div class="text-3xl font-bold text-cyan-500">{{ colorless_count }}</div>
        <div class="text-gray-400 text-sm">Colorless/Flexible</div>
        <div class="text-gray-500 text-xs mt-1">Diplomatic Seal, etc.</div>
    </div>
</div>

<!-- Influence Sources -->
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Influence Sources</h2>
    <div class="flex flex-wrap gap-4">
        {% for faction, count in influence_sources.items %}
        <div class="flex items-center gap-2 px-4 py-2 rounded-lg
            {% if faction == 'F' %}bg-red-900/50 border border-red-700
            {% elif faction == 'T' %}bg-yellow-900/50 border border-yellow-700
            {% elif faction == 'J' %}bg-green-900/50 border border-green-700
            {% elif faction == 'P' %}bg-blue-900/50 border border-blue-700
            {% elif faction == 'S' %}bg-purple-900/50 border border-purple-700
            {% endif %}">
            <span class="font-bold text-xl
                {% if faction == 'F' %}text-red-400
                {% elif faction == 'T' %}text-yellow-400
                {% elif faction == 'J' %}text-green-400
                {% elif faction == 'P' %}text-blue-400
                {% elif faction == 'S' %}text-purple-400
                {% endif %}">{{ count }}</span>
            <span class="text-gray-300">
                {% if faction == 'F' %}Fire{% elif faction == 'T' %}Time{% elif faction == 'J' %}Justice{% elif faction == 'P' %}Primal{% elif faction == 'S' %}Shadow{% endif %}
            </span>
        </div>
        {% empty %}
        <p class="text-gray-500">No influence sources found.</p>
        {% endfor %}
    </div>
</div>

<!-- Power Source Details -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <!-- Undepleted -->
    <div class="bg-gray-800 rounded-lg p-4">
        <h3 class="text-green-400 font-semibold mb-2">Undepleted Sources</h3>
        {% if power_sources.undepleted %}
        <ul class="space-y-1 text-sm">
            {% for ps in power_sources.undepleted %}
            <li class="flex justify-between">
                <span class="text-gray-300">{{ ps.card_name }}</span>
                <span class="text-gray-500">x{{ ps.quantity }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 text-sm">None</p>
        {% endif %}
    </div>

    <!-- Conditional -->
    <div class="bg-gray-800 rounded-lg p-4">
        <h3 class="text-yellow-400 font-semibold mb-2">Conditional Sources</h3>
        {% if power_sources.conditional %}
        <ul class="space-y-1 text-sm">
            {% for ps in power_sources.conditional %}
            <li class="flex justify-between">
                <span class="text-gray-300">{{ ps.card_name }}</span>
                <span class="text-gray-500">x{{ ps.quantity }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 text-sm">None</p>
        {% endif %}
    </div>

    <!-- Depleted -->
    <div class="bg-gray-800 rounded-lg p-4">
        <h3 class="text-red-400 font-semibold mb-2">Depleted Sources</h3>
        {% if power_sources.depleted %}
        <ul class="space-y-1 text-sm">
            {% for ps in power_sources.depleted %}
            <li class="flex justify-between">
                <span class="text-gray-300">{{ ps.card_name }}</span>
                <span class="text-gray-500">x{{ ps.quantity }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 text-sm">None</p>
        {% endif %}
    </div>

    <!-- Colorless -->
    <div class="bg-gray-800 rounded-lg p-4">
        <h3 class="text-cyan-400 font-semibold mb-2">Colorless/Flexible</h3>
        {% if power_sources.colorless %}
        <ul class="space-y-1 text-sm">
            {% for ps in power_sources.colorless %}
            <li class="flex justify-between">
                <span class="text-gray-300">{{ ps.card_name }}</span>
                <span class="text-gray-500">x{{ ps.quantity }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 text-sm">None</p>
        {% endif %}
    </div>
</div>

<!-- Power Odds Chart -->
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Power Odds Chart</h2>
    <p class="text-gray-400 text-sm mb-4">Probability of having at least X power by turn</p>
    <div class="h-64">
        <canvas id="powerChart"></canvas>
    </div>
</div>

<!-- Influence Odds Charts -->
{% if influence_tables %}
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Influence Odds Charts</h2>
    <p class="text-gray-400 text-sm mb-4">Probability of having at least X influence by turn (showing 2 influence requirement)</p>
    <div class="h-64">
        <canvas id="influenceChart"></canvas>
    </div>
</div>
{% endif %}

<!-- Power Odds Table -->
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Power Odds by Turn</h2>
    <p class="text-gray-400 text-sm mb-4">Probability (%) of having at least X power by turn N</p>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-3 py-2 text-left">Turn</th>
                    <th class="px-3 py-2 text-left text-gray-400">Cards</th>
                    <th class="px-3 py-2 text-center">1 Power</th>
                    <th class="px-3 py-2 text-center">2 Power</th>
                    <th class="px-3 py-2 text-center">3 Power</th>
                    <th class="px-3 py-2 text-center">4 Power</th>
                    <th class="px-3 py-2 text-center">5 Power</th>
                    <th class="px-3 py-2 text-center">6 Power</th>
                    <th class="px-3 py-2 text-center">7 Power</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for row in power_table %}
                <tr class="hover:bg-gray-750">
                    <td class="px-3 py-2 font-medium">{{ row.turn }}</td>
                    <td class="px-3 py-2 text-gray-500">{{ row.cards_seen }}</td>
                    <td class="px-3 py-2 text-center {% if row.power_1 >= 90 %}text-green-400{% elif row.power_1 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_1 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_2 >= 90 %}text-green-400{% elif row.power_2 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_2 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_3 >= 90 %}text-green-400{% elif row.power_3 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_3 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_4 >= 90 %}text-green-400{% elif row.power_4 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_4 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_5 >= 90 %}text-green-400{% elif row.power_5 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_5 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_6 >= 90 %}text-green-400{% elif row.power_6 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_6 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.power_7 >= 90 %}text-green-400{% elif row.power_7 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.power_7 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Influence Odds Tables -->
{% for faction, data in influence_tables.items %}
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3
        {% if faction == 'F' %}text-red-400
        {% elif faction == 'T' %}text-yellow-400
        {% elif faction == 'J' %}text-green-400
        {% elif faction == 'P' %}text-blue-400
        {% elif faction == 'S' %}text-purple-400
        {% endif %}">{{ data.name }} Influence Odds</h2>
    <p class="text-gray-400 text-sm mb-4">{{ data.sources }} sources in deck</p>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-3 py-2 text-left">Turn</th>
                    <th class="px-3 py-2 text-center">1 {{ faction }}</th>
                    <th class="px-3 py-2 text-center">2 {{ faction }}</th>
                    <th class="px-3 py-2 text-center">3 {{ faction }}</th>
                    <th class="px-3 py-2 text-center">4 {{ faction }}</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for row in data.table %}
                <tr class="hover:bg-gray-750">
                    <td class="px-3 py-2 font-medium">{{ row.turn }}</td>
                    <td class="px-3 py-2 text-center {% if row.inf_1 >= 90 %}text-green-400{% elif row.inf_1 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.inf_1 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.inf_2 >= 90 %}text-green-400{% elif row.inf_2 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.inf_2 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.inf_3 >= 90 %}text-green-400{% elif row.inf_3 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.inf_3 }}%</td>
                    <td class="px-3 py-2 text-center {% if row.inf_4 >= 90 %}text-green-400{% elif row.inf_4 >= 70 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ row.inf_4 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}

<!-- Key Cards Analysis -->
{% if key_cards %}
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Key Cards - On-Curve Odds</h2>
    <p class="text-gray-400 text-sm mb-4">Probability of casting each card on the turn matching its cost</p>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-3 py-2 text-left">Card</th>
                    <th class="px-3 py-2 text-center">Cost</th>
                    <th class="px-3 py-2 text-center">Influence</th>
                    <th class="px-3 py-2 text-center">Target Turn</th>
                    <th class="px-3 py-2 text-center">On-Curve Odds</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for item in key_cards %}
                <tr class="hover:bg-gray-750">
                    <td class="px-3 py-2">
                        <span class="font-medium">{{ item.card.name }}</span>
                        {% if item.quantity > 1 %}<span class="text-gray-500 ml-1">x{{ item.quantity }}</span>{% endif %}
                    </td>
                    <td class="px-3 py-2 text-center">{{ item.cost }}</td>
                    <td class="px-3 py-2 text-center">
                        {% for f, c in item.influence.items %}
                        <span class="{% if f == 'F' %}text-red-400{% elif f == 'T' %}text-yellow-400{% elif f == 'J' %}text-green-400{% elif f == 'P' %}text-blue-400{% elif f == 'S' %}text-purple-400{% endif %}">{{ c }}{{ f }}</span>
                        {% endfor %}
                    </td>
                    <td class="px-3 py-2 text-center">Turn {{ item.target_turn }}</td>
                    {% widthratio item.odds_on_curve 1 100 as odds_pct %}
                    <td class="px-3 py-2 text-center font-bold
                        {% if item.odds_on_curve >= 0.9 %}text-green-400
                        {% elif item.odds_on_curve >= 0.7 %}text-yellow-400
                        {% else %}text-red-400{% endif %}">
                        {{ odds_pct }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Footer Note -->
<div class="text-center text-gray-500 text-sm mt-8 mb-4">
    <p>Calculations based on hypergeometric distribution. Inspired by <a href="https://www.shiftstoned.com/epc/" target="_blank" class="text-amber-500 hover:underline">ShiftStoned Power Calculator</a>.</p>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js defaults for dark theme
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#374151';

    const turns = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

    // Power data from Django
    const powerData = {
        {% for row in power_table %}
        {{ row.turn }}: {
            power_1: {{ row.power_1 }},
            power_2: {{ row.power_2 }},
            power_3: {{ row.power_3 }},
            power_4: {{ row.power_4 }},
            power_5: {{ row.power_5 }},
            power_6: {{ row.power_6 }},
            power_7: {{ row.power_7 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // Power Odds Chart
    const powerCtx = document.getElementById('powerChart');
    if (powerCtx) {
        new Chart(powerCtx, {
            type: 'line',
            data: {
                labels: turns,
                datasets: [
                    {
                        label: '2 Power',
                        data: turns.map(t => powerData[t]?.power_2 || 0),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: '3 Power',
                        data: turns.map(t => powerData[t]?.power_3 || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: '4 Power',
                        data: turns.map(t => powerData[t]?.power_4 || 0),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: '5 Power',
                        data: turns.map(t => powerData[t]?.power_5 || 0),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: '6 Power',
                        data: turns.map(t => powerData[t]?.power_6 || 0),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Probability (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Turn'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Influence data from Django
    const influenceData = {
        {% for faction, data in influence_tables.items %}
        '{{ faction }}': {
            name: '{{ data.name }}',
            color: {% if faction == 'F' %}'#ef4444'{% elif faction == 'T' %}'#eab308'{% elif faction == 'J' %}'#22c55e'{% elif faction == 'P' %}'#3b82f6'{% elif faction == 'S' %}'#8b5cf6'{% else %}'#9ca3af'{% endif %},
            data: [{% for row in data.table %}{{ row.inf_2 }}{% if not forloop.last %}, {% endif %}{% endfor %}]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // Influence Odds Chart
    const influenceCtx = document.getElementById('influenceChart');
    if (influenceCtx && Object.keys(influenceData).length > 0) {
        const datasets = Object.entries(influenceData).map(([faction, info]) => ({
            label: info.name + ' (2)',
            data: info.data,
            borderColor: info.color,
            backgroundColor: info.color + '20',
            tension: 0.3,
            fill: false
        }));

        new Chart(influenceCtx, {
            type: 'line',
            data: {
                labels: turns,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Probability (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Turn'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
