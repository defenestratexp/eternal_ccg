{% extends "base.html" %}

{% block title %}Edit {{ deck.name }} - Eternal Forge{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold">Edit: {{ deck.name }}</h1>
        <p class="text-gray-400">{{ deck.format }} &bull; {{ deck.main_deck_count }} cards</p>
    </div>
    {% include 'decks/partials/deck_nav.html' with current_page='edit' %}
</div>

<div class="flex gap-6">
    <!-- Left: Card Search/Add -->
    <div class="w-2/3">

        <!-- Search Cards -->
        <div class="mb-4">
            <input type="text" id="card-search" placeholder="Search cards to add..."
                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                   oninput="filterCards(this.value)">
        </div>

        <!-- Card Grid for Adding -->
        <div id="available-cards" class="grid grid-cols-4 gap-2 max-h-[60vh] overflow-y-auto">
            {% for card in cards %}
            <div class="card-item bg-gray-800 rounded p-2 cursor-pointer hover:bg-gray-700 text-sm"
                 data-name="{{ card.name|lower }}"
                 hx-post="{% url 'decks:deck_add_card' deck.pk %}"
                 hx-vals='{"card_id": "{{ card.pk }}", "is_market": "false"}'
                 hx-target="#deck-summary"
                 hx-swap="innerHTML">
                {% if card.image_url %}
                <img src="{{ card.image_url }}" alt="{{ card.name }}" class="w-full rounded mb-1" loading="lazy">
                {% endif %}
                <p class="text-xs text-gray-300 truncate">{{ card.name }}</p>
                <p class="text-xs text-gray-500">{{ card.cost }} - {{ card.card_type }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right: Current Deck -->
    <div class="w-1/3">
        <div class="bg-gray-800 rounded-lg p-4 sticky top-4">
            <h2 class="text-lg font-semibold mb-4">Current Deck</h2>

            <div id="deck-summary">
                {% include "decks/partials/deck_summary.html" %}
            </div>

            <!-- Deck Metadata Form -->
            <form method="post" class="mt-4 pt-4 border-t border-gray-700">
                {% csrf_token %}
                <input type="text" name="name" value="{{ deck.name }}"
                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm mb-2">
                <select name="format" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm mb-2">
                    <option value="Throne" {% if deck.format == 'Throne' %}selected{% endif %}>Throne</option>
                    <option value="Expedition" {% if deck.format == 'Expedition' %}selected{% endif %}>Expedition</option>
                </select>
                <textarea name="description" rows="2" placeholder="Notes..."
                          class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white text-sm mb-2">{{ deck.description }}</textarea>
                <button type="submit" class="w-full px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded text-white text-sm">
                    Save Deck
                </button>
            </form>

            <div class="mt-4 flex gap-2">
                <a href="{% url 'decks:deck_detail' deck.pk %}" class="text-sm text-gray-400 hover:text-white">View</a>
                <a href="{% url 'decks:deck_export_view' deck.pk %}" class="text-sm text-gray-400 hover:text-white">Export</a>
            </div>
        </div>
    </div>
</div>

<script>
function filterCards(query) {
    query = query.toLowerCase();
    document.querySelectorAll('.card-item').forEach(item => {
        const name = item.dataset.name;
        item.style.display = name.includes(query) ? 'block' : 'none';
    });
}
</script>
{% endblock %}
